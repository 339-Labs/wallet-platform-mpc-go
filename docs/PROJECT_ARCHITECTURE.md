# MPC Wallet Platform 项目架构详解

> **协议版本**: 本项目基于 BNB Chain tss-lib，实现 **GG18 (Gennaro-Goldfeder 2018)** 门限签名协议

## 📋 目录

- [项目概述](#项目概述)
- [整体架构流程图](#整体架构流程图)
- [TSS-LIB 详解](#tss-lib-详解)
  - [GG18 协议简介](#gg18-协议简介)
  - [Keygen 流程](#keygen-密钥生成流程)
  - [Signing 流程](#signing-签名流程)
  - [Resharing 流程](#resharing-密钥重分享流程)
- [P2P 网络详解](#p2p-网络详解)
- [组件交互图](#组件交互图)

---

## 项目概述

这是一个基于 **门限签名方案 (TSS)** 的 **多方计算 (MPC)** 托管钱包后端实现。

### 核心特性

| 特性 | 说明 |
|------|------|
| **分布式密钥生成 (DKG)** | 多个节点协作生成密钥，无需任何单一方持有完整私钥 |
| **门限签名 (t-of-n)** | 需要至少 t 个节点协作才能生成有效签名 |
| **P2P 网络** | 基于 libp2p 的去中心化节点通信 |
| **安全存储** | 密钥分片使用 AES-GCM 加密存储在 LevelDB |
| **以太坊兼容** | 支持 EIP-155 交易签名 |

### 使用的核心库

- **BNB Chain tss-lib**: 实现 GG20 门限签名协议
- **libp2p**: P2P 网络通信
- **LevelDB**: 本地数据持久化

---

## 整体架构流程图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              MPC Wallet Platform                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────┐     ┌─────────────────────────────────────────────────────┐    │
│  │   Client    │────▶│                    API Layer                         │    │
│  │  (HTTP)     │     │  ┌───────────────────────────────────────────────┐  │    │
│  └─────────────┘     │  │              api/server.go                     │  │    │
│                      │  │  - POST /api/v1/wallets (创建钱包)             │  │    │
│                      │  │  - POST /api/v1/sign/message (签名消息)        │  │    │
│                      │  │  - POST /api/v1/sign/transaction (签名交易)    │  │    │
│                      │  │  - POST /api/v1/reshare (密钥重分享)           │  │    │
│                      │  └───────────────────────────────────────────────┘  │    │
│                      └──────────────────────┬──────────────────────────────┘    │
│                                             │                                    │
│                                             ▼                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                         Wallet Manager                                   │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │    │
│  │  │                    wallet/manager.go                             │    │    │
│  │  │  - CreateWallet() → 发起 DKG                                     │    │    │
│  │  │  - SignMessage() → 发起签名                                      │    │    │
│  │  │  - SignTransaction() → 签名以太坊交易                            │    │    │
│  │  │  - ReshareWallet() → 密钥重分享                                  │    │    │
│  │  └─────────────────────────────────────────────────────────────────┘    │    │
│  └──────────────────────────────┬──────────────────────────────────────────┘    │
│                                 │                                                │
│                                 ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                          TSS Layer                                       │    │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                │    │
│  │  │  Coordinator  │  │  KeygenMgr    │  │  SigningMgr   │                │    │
│  │  │               │──│               │  │               │                │    │
│  │  │ - 会话协调    │  │ - 密钥生成    │  │ - 签名生成    │                │    │
│  │  │ - 节点同步    │  │ - 轮次管理    │  │ - 轮次管理    │                │    │
│  │  └───────────────┘  └───────────────┘  └───────────────┘                │    │
│  │                            │                   │                         │    │
│  │                            ▼                   ▼                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │    │
│  │  │                   BNB Chain tss-lib                              │    │    │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │    │    │
│  │  │  │ keygen pkg  │  │ signing pkg │  │    resharing pkg        │  │    │    │
│  │  │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │    │    │
│  │  └─────────────────────────────────────────────────────────────────┘    │    │
│  └──────────────────────────────┬──────────────────────────────────────────┘    │
│                                 │                                                │
│                                 ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                          P2P Layer                                       │    │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────────────────┐    │    │
│  │  │   P2PHost     │  │    PubSub     │  │      Discovery            │    │    │
│  │  │               │──│  (GossipSub)  │  │  (DHT + mDNS)             │    │    │
│  │  │ - 连接管理    │  │               │  │                           │    │    │
│  │  │ - 消息路由    │  │ - 消息广播    │  │ - 节点发现                │    │    │
│  │  │ - 流处理      │  │ - 主题订阅    │  │ - 自动连接                │    │    │
│  │  └───────────────┘  └───────────────┘  └───────────────────────────┘    │    │
│  │                            │                                             │    │
│  │                            ▼                                             │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │    │
│  │  │                    libp2p (Go)                                   │    │    │
│  │  │  - 传输层: TCP, QUIC                                             │    │    │
│  │  │  - 安全层: TLS, Noise                                            │    │    │
│  │  │  - 多路复用: mplex, yamux                                        │    │    │
│  │  └─────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                        Storage Layer                                     │    │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────────────────┐    │    │
│  │  │ WalletRepo    │  │ KeyShareRepo  │  │      SessionRepo          │    │    │
│  │  │               │  │               │  │                           │    │    │
│  │  │ - 钱包元数据  │  │ - 密钥分片    │  │ - 会话状态                │    │    │
│  │  │               │  │ - AES-GCM加密 │  │                           │    │    │
│  │  └───────┬───────┘  └───────┬───────┘  └───────────┬───────────────┘    │    │
│  │          │                  │                      │                     │    │
│  │          └──────────────────┼──────────────────────┘                     │    │
│  │                             ▼                                            │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │    │
│  │  │                       LevelDB                                    │    │    │
│  │  └─────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## TSS-LIB 详解

### 什么是 TSS (Threshold Signature Scheme)?

TSS 是一种密码学协议，允许 n 个参与方共同持有一个私钥的"份额"，只有至少 t 个参与方协作才能生成有效签名。

**关键概念:**
- **t-of-n 方案**: n 个参与方中需要至少 t 个协作
- **无单点故障**: 没有任何单一参与方能独自签名
- **密钥永不重建**: 完整私钥从未在任何地方出现

### GG18 协议简介

本项目使用的 BNB Chain tss-lib 实现的是 **GG18 (Gennaro-Goldfeder 2018)** 协议，论文标题为 *"Fast Multiparty Threshold ECDSA with Fast Trustless Setup"*。

**GG18 vs GG20 的区别:**

| 特性 | GG18 | GG20 |
|------|------|------|
| MtA 协议 | Paillier 加密 | OT-based / Paillier |
| 可识别中止 | 不支持 | 支持 |
| 预签名 | 不支持 | 支持 |
| 轮次 (签名) | 6-8 轮 | 4-6 轮 |
| 复杂度 | 较简单 | 较复杂 |

### tss-lib 内部阈值说明

⚠️ **重要**: tss-lib 内部使用的 threshold 与用户视角不同！

| 概念 | 用户视角 | tss-lib 内部 |
|------|---------|-------------|
| threshold | 签名所需最少节点数 | threshold - 1 |
| 示例 | 3个节点中需要2个 | threshold=1 |

在代码中的体现 (`party.go`):

```go
// 用户的 threshold 表示签名所需节点数，TSS 库需要 threshold-1
tssThreshold := threshold - 1
params := tss.NewParameters(tss.S256(), ctx, ourPartyID, len(partyIDs), tssThreshold)
```

---

### Keygen (密钥生成) 流程

#### 流程图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Keygen (DKG) 流程                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   Client                  Node-1 (发起者)           Node-2              Node-3   │
│     │                         │                       │                   │      │
│     │  POST /wallets          │                       │                   │      │
│     │ ───────────────────────▶│                       │                   │      │
│     │                         │                       │                   │      │
│     │                    ┌────┴────┐                  │                   │      │
│     │                    │ 创建会话 │                  │                   │      │
│     │                    │ 生成UUID │                  │                   │      │
│     │                    └────┬────┘                  │                   │      │
│     │                         │                       │                   │      │
│     │                         │   keygen_init         │                   │      │
│     │                         │ ─────────────────────▶│                   │      │
│     │                         │ ─────────────────────────────────────────▶│      │
│     │                         │                       │                   │      │
│     │                    ┌────┴────┐             ┌────┴────┐         ┌────┴────┐ │
│     │                    │Prepare  │             │Prepare  │         │Prepare  │ │
│     │                    │Keygen   │             │Keygen   │         │Keygen   │ │
│     │                    └────┬────┘             └────┬────┘         └────┬────┘ │
│     │                         │                       │                   │      │
│     │                         │   keygen_ready        │                   │      │
│     │                         │ ◀─────────────────────│                   │      │
│     │                         │ ◀─────────────────────────────────────────│      │
│     │                         │                       │                   │      │
│     │                    ┌────┴────┐                  │                   │      │
│     │                    │ 检查所有 │                  │                   │      │
│     │                    │ 节点就绪 │                  │                   │      │
│     │                    └────┬────┘                  │                   │      │
│     │                         │                       │                   │      │
│     │                         │   keygen_start        │                   │      │
│     │                         │ ─────────────────────▶│                   │      │
│     │                         │ ─────────────────────────────────────────▶│      │
│     │                         │                       │                   │      │
│ ════╪═════════════════════════╪═══════════════════════╪═══════════════════╪══════╡
│     │                         │    TSS Protocol       │                   │      │
│ ════╪═════════════════════════╪═══════════════════════╪═══════════════════╪══════╡
│     │                         │                       │                   │      │
│     │                    ┌────┴────────────────────────────────────────────┐     │
│     │                    │              Round 1: 生成随机数                 │     │
│     │                    │  - 每个节点生成随机数 uᵢ                         │     │
│     │                    │  - 计算承诺 Cᵢ = H(g^uᵢ)                        │     │
│     │                    │  - 广播承诺                                      │     │
│     │                    └─────────────────────────────────────────────────┘     │
│     │                         │  broadcast Cᵢ        │                   │      │
│     │                         │ ◀────────────────────▶│                   │      │
│     │                         │ ◀────────────────────────────────────────▶│      │
│     │                         │                       │                   │      │
│     │                    ┌────┴────────────────────────────────────────────┐     │
│     │                    │              Round 2: 揭示承诺                   │     │
│     │                    │  - 揭示 g^uᵢ                                     │     │
│     │                    │  - 验证所有承诺                                  │     │
│     │                    └─────────────────────────────────────────────────┘     │
│     │                         │  reveal g^uᵢ         │                   │      │
│     │                         │ ◀────────────────────▶│                   │      │
│     │                         │ ◀────────────────────────────────────────▶│      │
│     │                         │                       │                   │      │
│     │                    ┌────┴────────────────────────────────────────────┐     │
│     │                    │              Round 3: Feldman VSS               │     │
│     │                    │  - 生成随机多项式 f(x)                           │     │
│     │                    │  - 发送 sᵢⱼ = f(j) 给节点 j (点对点)             │     │
│     │                    │  - 广播多项式系数的承诺                          │     │
│     │                    └─────────────────────────────────────────────────┘     │
│     │                         │  p2p: sᵢⱼ            │                   │      │
│     │                         │ ◀────────────────────▶│                   │      │
│     │                         │ ◀────────────────────────────────────────▶│      │
│     │                         │                       │                   │      │
│     │                    ┌────┴────────────────────────────────────────────┐     │
│     │                    │              验证并计算                          │     │
│     │                    │  - 验证收到的分片: g^sᵢⱼ = ∏ Aᵢₖ^(j^k)          │     │
│     │                    │  - 计算本地密钥分片: xⱼ = Σ sᵢⱼ                 │     │
│     │                    │  - 计算公钥: X = Σ g^aᵢ₀                        │     │
│     │                    └─────────────────────────────────────────────────┘     │
│     │                         │                       │                   │      │
│     │                    ┌────┴────┐             ┌────┴────┐         ┌────┴────┐ │
│     │                    │保存分片  │             │保存分片  │         │保存分片  │ │
│     │                    │到LevelDB│             │到LevelDB│         │到LevelDB│ │
│     │                    └────┬────┘             └────┬────┘         └────┬────┘ │
│     │                         │                       │                   │      │
│     │ ◀───────────────────────│                       │                   │      │
│     │   返回钱包信息(地址,公钥)│                       │                   │      │
│     │                         │                       │                   │      │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 代码流程

```
1. API 请求
   └── api/server.go: createWallet()
       └── wallet/manager.go: CreateWallet()
           └── tss/coordinator.go: InitiateKeygen()
               ├── 广播 keygen_init 消息
               ├── tss/keygen.go: PrepareKeygen() // 创建会话
               ├── 等待所有节点 ready
               ├── 广播 keygen_start 消息
               └── session.Start() // 启动 TSS 协议

2. TSS 协议执行
   └── tss/keygen.go: run()
       ├── 创建 LocalParty (tss-lib)
       ├── 主循环:
       │   ├── outChan → 发送消息 (广播/点对点)
       │   ├── msgHandler.MsgChan → 处理收到的消息
       │   └── endChan → 协议完成
       └── handleSuccess() → 保存密钥分片
```

#### 关键数据结构

**KeygenSession** (`keygen.go`):
```go
type KeygenSession struct {
    ID          string
    WalletID    string
    Threshold   int                    // 签名所需最少节点数
    TotalParts  int                    // 总节点数
    NodeIDs     []string               // 参与方节点ID列表
    
    partyIDs    tss.SortedPartyIDs     // 排序后的参与方ID
    params      *tss.Parameters        // TSS参数
    party       tss.Party              // TSS LocalParty
    
    outChan     chan tss.Message       // 输出消息通道
    endChan     chan *keygen.LocalPartySaveData  // 结果通道
    msgHandler  *p2p.SessionMessageHandler       // P2P消息处理器
}
```

**LocalPartySaveData** (tss-lib):
```go
// 密钥生成后保存的本地数据
type LocalPartySaveData struct {
    Xi          *big.Int        // 本地私钥分片
    ShareID     *big.Int        // 分片ID
    Ks          []*big.Int      // 所有参与方的分片ID
    BigXj       []*crypto.ECPoint // 所有参与方的公钥分片
    ECDSAPub    *crypto.ECPoint   // 聚合公钥 (即钱包公钥)
    // ...
}
```

---

### Signing (签名) 流程

#### 流程图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         GG18 Signing 流程                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   Client                  Node-1 (发起者)           Node-2              Node-3   │
│     │                         │                       │                   │      │
│     │  POST /sign/message     │                       │                   │      │
│     │ ───────────────────────▶│                       │                   │      │
│     │  (只选择 node-1, node-2 参与)                   │                   │      │
│     │                         │                       │                   │      │
│     │                    ┌────┴────┐                  │                   │      │
│     │                    │计算消息  │                  │                   │      │
│     │                    │  哈希    │                  │                   │      │
│     │                    └────┬────┘                  │                   │      │
│     │                         │                       │                   │      │
│     │                         │   sign_init           │                   │      │
│     │                         │ ─────────────────────▶│                   │      │
│     │                         │   (node-3 不参与)     │                   │      │
│     │                         │                       │                   │      │
│     │                    ┌────┴────┐             ┌────┴────┐              │      │
│     │                    │Prepare  │             │Prepare  │              │      │
│     │                    │Signing  │             │Signing  │              │      │
│     │                    │加载密钥 │             │加载密钥 │              │      │
│     │                    │分片     │             │分片     │              │      │
│     │                    └────┬────┘             └────┬────┘              │      │
│     │                         │                       │                   │      │
│     │                         │   sign_ready          │                   │      │
│     │                         │ ◀─────────────────────│                   │      │
│     │                         │                       │                   │      │
│     │                         │   sign_start          │                   │      │
│     │                         │ ─────────────────────▶│                   │      │
│     │                         │                       │                   │      │
│ ════╪═════════════════════════╪═══════════════════════╪═══════════════════╪══════╡
│     │                    GG18 Signing Protocol        │                   │      │
│ ════╪═════════════════════════╪═══════════════════════╪═══════════════════╪══════╡
│     │                         │                       │                   │      │
│     │                    ┌────┴────────────────────────────────────────────┐     │
│     │                    │     Round 1: 生成随机数和承诺                    │     │
│     │                    │  - 每个签名者生成随机数 kᵢ, γᵢ                   │     │
│     │                    │  - 计算承诺: Cᵢ = H(Γᵢ) 其中 Γᵢ = g^γᵢ          │     │
│     │                    │  - 使用 Paillier 公钥加密 kᵢ: cᵢ = Enc(kᵢ)      │     │
│     │                    │  - 广播 (Cᵢ, cᵢ, Paillier公钥证明)              │     │
│     │                    └─────────────────────────────────────────────────┘     │
│     │                         │  broadcast round1    │                   │      │
│     │                         │ ◀────────────────────▶│                   │      │
│     │                         │                       │                   │      │
│     │                    ┌────┴────────────────────────────────────────────┐     │
│     │                    │     Round 2: 揭示承诺 + Paillier MtA             │     │
│     │                    │  - 揭示 Γᵢ = g^γᵢ                               │     │
│     │                    │  - 验证承诺: H(Γᵢ) == Cᵢ                        │     │
│     │                    │  - 对每个节点 j 执行 Paillier MtA:               │     │
│     │                    │    · 发送 cⱼ^γᵢ · Enc(-βᵢⱼ) 给节点 j            │     │
│     │                    │    · 收到后解密得到 αⱼᵢ = kⱼγᵢ - βᵢⱼ            │     │
│     │                    └─────────────────────────────────────────────────┘     │
│     │                         │  p2p: MtA messages   │                   │      │
│     │                         │ ◀────────────────────▶│                   │      │
│     │                         │                       │                   │      │
│     │                    ┌────┴────────────────────────────────────────────┐     │
│     │                    │     Round 3: MtAwc (乘法转加法 with check)       │     │
│     │                    │  - 执行 MtAwc: kᵢ * wⱼ (wⱼ = xⱼ * lagrange)    │     │
│     │                    │  - 使用相同的 Paillier 机制                      │     │
│     │                    │  - 得到: kᵢwⱼ = μᵢⱼ + νⱼᵢ                       │     │
│     │                    └─────────────────────────────────────────────────┘     │
│     │                         │  p2p: MtAwc data     │                   │      │
│     │                         │ ◀────────────────────▶│                   │      │
│     │                         │                       │                   │      │
│     │                    ┌────┴────────────────────────────────────────────┐     │
│     │                    │     Round 4: 计算 δᵢ                             │     │
│     │                    │  - δᵢ = kᵢγᵢ + Σⱼαᵢⱼ + Σⱼβⱼᵢ                   │     │
│     │                    │  - 广播 δᵢ                                      │     │
│     │                    └─────────────────────────────────────────────────┘     │
│     │                         │  broadcast δᵢ        │                   │      │
│     │                         │ ◀────────────────────▶│                   │      │
│     │                         │                       │                   │      │
│     │                    ┌────┴────────────────────────────────────────────┐     │
│     │                    │     Round 5: 计算 R                              │     │
│     │                    │  - δ = Σᵢδᵢ (mod q)                             │     │
│     │                    │  - Γ = Πᵢ Γᵢ = g^(Σγᵢ)                          │     │
│     │                    │  - R = Γ^(δ⁻¹) = g^(Σγᵢ/Σkᵢγᵢ) = g^(1/Σkᵢ)     │     │
│     │                    │  - r = R.x mod q                                │     │
│     │                    └─────────────────────────────────────────────────┘     │
│     │                         │                       │                   │      │
│     │                    ┌────┴────────────────────────────────────────────┐     │
│     │                    │     Round 6: 计算签名分片                        │     │
│     │                    │  - σᵢ = kᵢwᵢ + Σⱼμᵢⱼ + Σⱼνⱼᵢ                   │     │
│     │                    │  - sᵢ = m·kᵢ + r·σᵢ                             │     │
│     │                    │  - 广播 sᵢ                                      │     │
│     │                    └─────────────────────────────────────────────────┘     │
│     │                         │  broadcast sᵢ        │                   │      │
│     │                         │ ◀────────────────────▶│                   │      │
│     │                         │                       │                   │      │
│     │                    ┌────┴────────────────────────────────────────────┐     │
│     │                    │     聚合签名并验证                               │     │
│     │                    │  - s = Σᵢsᵢ (mod q)                             │     │
│     │                    │  - 验证签名: (r, s) 对公钥有效                   │     │
│     │                    │  - 最终签名: (r, s, v)                           │     │
│     │                    └─────────────────────────────────────────────────┘     │
│     │                         │                       │                   │      │
│     │ ◀───────────────────────│                       │                   │      │
│     │   返回签名 (r, s, v)    │                       │                   │      │
│     │                         │                       │                   │      │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### Paillier MtA (Multiplicative-to-Additive) 协议详解

MtA 是 GG18 签名协议的核心，使用 **Paillier 同态加密** 实现。它允许两个参与方在不暴露各自秘密的情况下，将乘法关系转换为加法关系。

**Paillier 加密特性:**
- 加法同态: `Enc(a) · Enc(b) = Enc(a + b)`
- 标量乘法: `Enc(a)^b = Enc(a · b)`

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                   GG18 Paillier MtA 协议示意图                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│      Party i (持有 a, Paillier密钥)          Party j (持有 b)                    │
│            │                                    │                                │
│            │                                    │                                │
│    目标: 计算 αᵢⱼ + βⱼᵢ = a·b                   │                                │
│    (i 得到 αᵢⱼ, j 得到 βⱼᵢ)                     │                                │
│            │                                    │                                │
│  ┌─────────┴─────────┐                          │                                │
│  │ Keygen 阶段已生成 │                          │                                │
│  │ Paillier 密钥对   │                          │                                │
│  │ (pkᵢ, skᵢ)       │                          │                                │
│  │                   │                          │                                │
│  │ Round 1 广播:     │                          │                                │
│  │ cᵢ = Enc(kᵢ)     │                          │                                │
│  └─────────┬─────────┘                          │                                │
│            │                                    │                                │
│            │    Round 1: 广播 cᵢ, pkᵢ           │                                │
│            │ ──────────────────────────────────▶│                                │
│            │                                    │                                │
│            │                          ┌─────────┴─────────┐                      │
│            │                          │ Round 2:          │                      │
│            │                          │ 1. 选择随机数 βⱼᵢ  │                      │
│            │                          │ 2. 计算:          │                      │
│            │                          │    Dⱼᵢ = cᵢ^γⱼ   │                      │
│            │                          │        · Enc(-βⱼᵢ)│                      │
│            │                          │    = Enc(kᵢγⱼ-βⱼᵢ)│                      │
│            │                          │ 3. 生成 Range Proof│                     │
│            │                          └─────────┬─────────┘                      │
│            │                                    │                                │
│            │    Round 2: 发送 Dⱼᵢ, 证明         │                                │
│            │ ◀──────────────────────────────────│                                │
│            │                                    │                                │
│  ┌─────────┴─────────┐                          │                                │
│  │ Round 3:          │                          │                                │
│  │ 1. 验证证明       │                          │                                │
│  │ 2. 解密得到       │                          │                                │
│  │    αᵢⱼ = Dec(Dⱼᵢ)│                          │                                │
│  │    = kᵢγⱼ - βⱼᵢ  │                          │                                │
│  └─────────┬─────────┘                          │                                │
│            │                                    │                                │
│    结果: αᵢⱼ = kᵢγⱼ - βⱼᵢ           结果: βⱼᵢ (保留)                           │
│                                                                                  │
│    验证: αᵢⱼ + βⱼᵢ = (kᵢγⱼ - βⱼᵢ) + βⱼᵢ = kᵢγⱼ  ✓                              │
│                                                                                  │
│  ───────────────────────────────────────────────────────────────────────────    │
│                                                                                  │
│    MtAwc (with check) 协议类似，用于计算 kᵢ * wⱼ                                │
│    其中 wⱼ = xⱼ * L(j) 是拉格朗日插值后的私钥分片                               │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

**安全证明:**
- GG18 使用 Range Proof 确保参与方的输入在合理范围内
- 防止恶意参与方使用过大的值导致信息泄露

#### 代码流程

```
1. API 请求
   └── api/server.go: signMessage()
       └── wallet/manager.go: SignMessage()
           ├── 计算消息哈希 (Keccak256)
           └── tss/coordinator.go: InitiateSign()
               ├── 广播 sign_init 消息
               ├── tss/signing.go: PrepareSigning()
               │   └── 加载本地密钥分片
               ├── 等待所有签名节点 ready
               ├── 广播 sign_start 消息
               └── session.Start()

2. TSS 签名协议
   └── tss/signing.go: run()
       ├── 创建 signing.LocalParty (tss-lib)
       ├── 传入消息哈希和密钥分片
       └── 主循环处理消息交换
           └── endChan → 收到最终签名
```

---

### Resharing (密钥重分享) 流程

#### 应用场景

| 场景 | 说明 |
|------|------|
| 定期刷新分片 | 防止长期密钥泄露，定期更新分片但保持公钥不变 |
| 添加/移除参与方 | 增加新节点或移除旧节点 |
| 修改签名阈值 | 例如从 2-of-3 改为 3-of-4 |
| 替换泄露节点 | 当某节点可能被攻击时，生成新分片使旧分片失效 |

#### 流程图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Resharing 流程                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   旧成员: [Node-1, Node-2, Node-3]    新成员: [Node-1, Node-2, Node-4, Node-5]   │
│   旧阈值: 2-of-3                      新阈值: 3-of-4                             │
│                                                                                  │
│   Node-1         Node-2         Node-3         Node-4         Node-5            │
│   (旧+新)        (旧+新)        (仅旧)         (仅新)         (仅新)            │
│     │              │              │              │              │                │
│     │              │              │              │              │                │
│  ┌──┴──┐        ┌──┴──┐        ┌──┴──┐        ┌──┴──┐        ┌──┴──┐            │
│  │加载旧│        │加载旧│        │加载旧│        │     │        │     │            │
│  │密钥  │        │密钥  │        │密钥  │        │(无) │        │(无) │            │
│  │分片  │        │分片  │        │分片  │        │     │        │     │            │
│  └──┬──┘        └──┬──┘        └──┬──┘        └──┬──┘        └──┬──┘            │
│     │              │              │              │              │                │
│ ════╪══════════════╪══════════════╪══════════════╪══════════════╪════════════════╡
│     │         TSS Resharing Protocol              │              │                │
│ ════╪══════════════╪══════════════╪══════════════╪══════════════╪════════════════╡
│     │              │              │              │              │                │
│  ┌──┴──────────────┴──────────────┴──────────────┴──────────────┴──┐            │
│  │  Round 1: 旧成员生成新的多项式分片                                │            │
│  │  - 旧成员 i 使用现有分片 xᵢ 作为常数项                           │            │
│  │  - 生成新的随机多项式 fᵢ(x), 其中 fᵢ(0) = xᵢ                    │            │
│  │  - 准备发送给新成员的分片                                        │            │
│  └──┬──────────────┬──────────────┬──────────────┬──────────────┬──┘            │
│     │              │              │              │              │                │
│  ┌──┴──────────────┴──────────────┴──────────────┴──────────────┴──┐            │
│  │  Round 2: VSS 分发                                               │            │
│  │  - 旧成员向新成员发送分片                                        │            │
│  │  - 广播多项式系数的承诺                                          │            │
│  └──┬──────────────┬──────────────┬──────────────┬──────────────┬──┘            │
│     │    分片      │    分片      │    分片      │              │                │
│     │ ─────────────────────────────────────────▶│              │                │
│     │ ─────────────────────────────────────────────────────────▶│                │
│     │              │              │              │              │                │
│  ┌──┴──────────────┴──────────────┴──────────────┴──────────────┴──┐            │
│  │  Round 3: 新成员验证并聚合                                       │            │
│  │  - 新成员验证收到的分片                                          │            │
│  │  - 聚合生成新的密钥分片: x'ⱼ = Σᵢ sᵢⱼ                           │            │
│  │  - 公钥保持不变: X = g^x = g^(Σxᵢ) = g^(Σx'ⱼ)                   │            │
│  └──┬──────────────┬──────────────┬──────────────┬──────────────┬──┘            │
│     │              │              │              │              │                │
│  ┌──┴──┐        ┌──┴──┐        ┌──┴──┐        ┌──┴──┐        ┌──┴──┐            │
│  │保存新│        │保存新│        │旧分片│        │保存新│        │保存新│            │
│  │分片  │        │分片  │        │作废  │        │分片  │        │分片  │            │
│  └──┬──┘        └──┬──┘        └──┬──┘        └──┬──┘        └──┬──┘            │
│     │              │              │              │              │                │
│                                                                                  │
│   结果: 公钥和地址保持不变，但密钥分片已更新                                      │
│         旧的分片 (包括 Node-3 的) 完全失效                                        │
│         现在需要 Node-1, Node-2, Node-4, Node-5 中的任意 3 个才能签名            │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 关键代码逻辑

```go
// resharing.go - run()
func (s *ResharingSession) run(ctx context.Context, timeout time.Duration) {
    // 根据角色创建不同的 Party
    if s.IsOldMember {
        // 旧成员 - 持有密钥分片，参与分发
        s.party = resharing.NewLocalParty(s.params, *s.oldKeyData, s.outChan, s.endChan)
    } else {
        // 新成员 - 不持有密钥分片，只接收
        s.party = resharing.NewLocalParty(s.params, keygen.LocalPartySaveData{}, s.outChan, s.endChan)
    }
    
    // 启动协议并处理消息
    // ...
}

// handleSuccess - 只有新成员保存新分片
func (s *ResharingSession) handleSuccess(result *keygen.LocalPartySaveData) {
    if s.IsNewMember {
        // 保存新的密钥分片
        s.keyShareRepo.SaveKeyShare(s.WalletID, s.LocalNodeID, result)
        // 更新钱包信息
        wallet.Threshold = s.NewThreshold
        wallet.PartyIDs = s.NewPartyIDs
    } else {
        // 旧成员的分片已作废
        log.Info("Resharing completed (old member - share invalidated)")
    }
}
```

---

## P2P 网络详解

### P2P 架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              P2P 网络架构                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│                           ┌───────────────┐                                      │
│                           │   P2PHost     │                                      │
│                           │  (host.go)    │                                      │
│                           └───────┬───────┘                                      │
│                                   │                                              │
│         ┌─────────────────────────┼─────────────────────────┐                    │
│         │                         │                         │                    │
│         ▼                         ▼                         ▼                    │
│  ┌─────────────┐          ┌─────────────┐          ┌─────────────┐              │
│  │ Discovery   │          │  PubSub     │          │ NodeManager │              │
│  │(discovery.go)│          │(pubsub.go)  │          │ (node.go)   │              │
│  └──────┬──────┘          └──────┬──────┘          └──────┬──────┘              │
│         │                        │                        │                      │
│  ┌──────┴──────┐          ┌──────┴──────┐          ┌──────┴──────┐              │
│  │   DHT       │          │  GossipSub  │          │  状态跟踪   │              │
│  │  发现       │          │   广播      │          │  心跳检测   │              │
│  ├─────────────┤          ├─────────────┤          ├─────────────┤              │
│  │   mDNS      │          │   Topics:   │          │  事件通知   │              │
│  │  本地发现   │          │ - keygen    │          │             │              │
│  └─────────────┘          │ - sign      │          └─────────────┘              │
│                           │ - broadcast │                                        │
│                           │ - heartbeat │                                        │
│                           └─────────────┘                                        │
│                                                                                  │
│                    ┌──────────────────────────┐                                  │
│                    │    MessageManager        │                                  │
│                    │     (message.go)         │                                  │
│                    ├──────────────────────────┤                                  │
│                    │ - 会话消息路由            │                                  │
│                    │ - 消息分发到对应Session  │                                  │
│                    │ - 广播/点对点发送        │                                  │
│                    └──────────────────────────┘                                  │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                          libp2p Host                                     │    │
│  ├─────────────────────────────────────────────────────────────────────────┤    │
│  │  协议:                                                                   │    │
│  │  - /mpc-wallet/tss/1.0.0     (TSS消息流)                                │    │
│  │  - /mpc-wallet/keygen/1.0.0  (密钥生成消息流)                           │    │
│  │  - /mpc-wallet/sign/1.0.0    (签名消息流)                               │    │
│  │                                                                          │    │
│  │  安全层:                                                                 │    │
│  │  - TLS 1.3                                                               │    │
│  │  - Noise Protocol                                                        │    │
│  │                                                                          │    │
│  │  功能:                                                                   │    │
│  │  - NAT穿透 (Hole Punching)                                              │    │
│  │  - 中继连接 (Relay)                                                      │    │
│  │  - UPnP/NAT-PMP                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 节点发现机制

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            节点发现流程                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    1. Bootstrap (引导节点连接)                           │    │
│  ├─────────────────────────────────────────────────────────────────────────┤    │
│  │                                                                          │    │
│  │     新节点                              引导节点                          │    │
│  │       │                                    │                             │    │
│  │       │  连接到配置的引导节点地址           │                             │    │
│  │       │ ──────────────────────────────────▶│                             │    │
│  │       │                                    │                             │    │
│  │       │  交换 Peer 信息                    │                             │    │
│  │       │ ◀──────────────────────────────────│                             │    │
│  │       │                                    │                             │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    2. DHT Discovery (广域网发现)                         │    │
│  ├─────────────────────────────────────────────────────────────────────────┤    │
│  │                                                                          │    │
│  │                        Kademlia DHT                                      │    │
│  │                            │                                             │    │
│  │         ┌──────────────────┼──────────────────┐                          │    │
│  │         │                  │                  │                          │    │
│  │         ▼                  ▼                  ▼                          │    │
│  │     Node-1             Node-2             Node-3                         │    │
│  │         │                  │                  │                          │    │
│  │         │  Advertise("mpc-wallet")           │                          │    │
│  │         │ ─────────────────────────────────▶ DHT                        │    │
│  │         │                                     │                          │    │
│  │         │  FindPeers("mpc-wallet")           │                          │    │
│  │         │ ◀───────────────────────────────── │                          │    │
│  │         │                                     │                          │    │
│  │         │  返回 [Node-2, Node-3, ...]        │                          │    │
│  │         │                                     │                          │    │
│  │    发现间隔: 30秒                             │                          │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    3. mDNS Discovery (局域网发现)                        │    │
│  ├─────────────────────────────────────────────────────────────────────────┤    │
│  │                                                                          │    │
│  │     同一局域网                                                           │    │
│  │     ┌──────────────────────────────────────────────┐                    │    │
│  │     │                                              │                    │    │
│  │     │  Node-1            Node-2           Node-3   │                    │    │
│  │     │    │                 │                │      │                    │    │
│  │     │    │  mDNS Query     │                │      │                    │    │
│  │     │    │ (_mpc-wallet._tcp)               │      │                    │    │
│  │     │    │ ═══════════════▶│                │      │                    │    │
│  │     │    │ ═══════════════════════════════▶│      │                    │    │
│  │     │    │                 │                │      │                    │    │
│  │     │    │  mDNS Response  │                │      │                    │    │
│  │     │    │ ◀═══════════════│                │      │                    │    │
│  │     │    │ ◀═══════════════════════════════│      │                    │    │
│  │     │                                              │                    │    │
│  │     └──────────────────────────────────────────────┘                    │    │
│  │                                                                          │    │
│  │     优点: 无需引导节点，零配置发现                                       │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### PubSub 消息广播

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        GossipSub 消息广播                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   Topic: "mpc/broadcast"                                                        │
│                                                                                  │
│              发送者                                                              │
│                │                                                                 │
│                │  Publish(msg)                                                  │
│                ▼                                                                 │
│        ┌───────────────┐                                                        │
│        │  GossipSub    │                                                        │
│        │   Router      │                                                        │
│        └───────┬───────┘                                                        │
│                │                                                                 │
│     ┌──────────┼──────────┐                                                     │
│     │          │          │                                                     │
│     ▼          ▼          ▼                                                     │
│  ┌──────┐  ┌──────┐  ┌──────┐                                                  │
│  │Peer 1│  │Peer 2│  │Peer 3│                                                  │
│  └──┬───┘  └──┬───┘  └──┬───┘                                                  │
│     │         │         │                                                       │
│     │         ▼         │       二次传播 (Gossip)                               │
│     │      ┌──────┐     │                                                       │
│     │      │Peer 4│     │                                                       │
│     │      └──────┘     │                                                       │
│     │                   │                                                       │
│     └──────────────────▶│                                                       │
│                 ┌──────┐                                                        │
│                 │Peer 5│                                                        │
│                 └──────┘                                                        │
│                                                                                  │
│   特性:                                                                          │
│   - 消息签名验证 (StrictSign)                                                   │
│   - 历史消息缓存 (防止重复处理)                                                  │
│   - 心跳机制 (检测节点状态)                                                      │
│   - 自动剪枝 (移除不活跃的连接)                                                  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 消息类型与路由

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           消息类型与处理                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  P2P 消息结构:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  {                                                                       │    │
│  │    "type": "keygen_round",      // 消息类型                             │    │
│  │    "session_id": "uuid...",     // 会话ID                               │    │
│  │    "from": "node-1",            // 发送方                               │    │
│  │    "to": "node-2",              // 接收方 (空=广播)                     │    │
│  │    "round": 1,                  // 轮次                                 │    │
│  │    "data": [...],               // TSS消息数据                          │    │
│  │    "timestamp": 1234567890      // 时间戳                               │    │
│  │  }                                                                       │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  消息类型路由:                                                                   │
│  ┌────────────────────┬───────────────────────────────────────────────────┐    │
│  │     消息类型        │              处理函数                             │    │
│  ├────────────────────┼───────────────────────────────────────────────────┤    │
│  │  keygen_init       │  coordinator.handleKeygenInit()                   │    │
│  │  keygen_ready      │  coordinator.handleKeygenReady()                  │    │
│  │  keygen_start      │  coordinator.handleKeygenStart()                  │    │
│  │  keygen_round      │  messageManager.routeToSession() → KeygenSession │    │
│  │  sign_init         │  coordinator.handleSignInit()                     │    │
│  │  sign_ready        │  coordinator.handleSignReady()                    │    │
│  │  sign_start        │  coordinator.handleSignStart()                    │    │
│  │  sign_round        │  messageManager.routeToSession() → SigningSession│    │
│  │  ping              │  messageManager.handlePingMessage()               │    │
│  │  node_info         │  messageManager.handleNodeInfoMessage()           │    │
│  └────────────────────┴───────────────────────────────────────────────────┘    │
│                                                                                  │
│  会话消息路由流程:                                                               │
│                                                                                  │
│     P2P Message                                                                  │
│         │                                                                        │
│         ▼                                                                        │
│   ┌─────────────┐                                                               │
│   │ PubSub      │  接收消息                                                     │
│   │ readLoop()  │                                                               │
│   └──────┬──────┘                                                               │
│          │                                                                       │
│          ▼                                                                       │
│   ┌─────────────┐                                                               │
│   │ P2PHost     │  路由到对应 handler                                           │
│   │ msgHandlers │                                                               │
│   └──────┬──────┘                                                               │
│          │                                                                       │
│          ▼                                                                       │
│   ┌─────────────┐                                                               │
│   │ MessageMgr  │  根据 session_id 路由                                         │
│   │ routeToSess │                                                               │
│   └──────┬──────┘                                                               │
│          │                                                                       │
│          ▼                                                                       │
│   ┌─────────────┐                                                               │
│   │  Session    │  处理 TSS 消息                                                │
│   │  MsgChan    │                                                               │
│   └─────────────┘                                                               │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 组件交互图

### 创建钱包完整流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                     创建钱包 - 完整组件交互流程                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Client                                                                          │
│    │                                                                             │
│    │ POST /api/v1/wallets                                                       │
│    │ {name:"MyWallet", threshold:2, total_parts:3, party_ids:[...]}             │
│    │                                                                             │
│    ▼                                                                             │
│  ┌─────────────────┐                                                            │
│  │   API Server    │                                                            │
│  │ (api/server.go) │                                                            │
│  └────────┬────────┘                                                            │
│           │ createWallet()                                                       │
│           ▼                                                                      │
│  ┌─────────────────┐                                                            │
│  │ Wallet Manager  │                                                            │
│  │(wallet/manager) │                                                            │
│  └────────┬────────┘                                                            │
│           │ CreateWallet()                                                       │
│           │                                                                      │
│           ├──────────────────────────────────────────────────────────────┐      │
│           │ InitiateKeygen()                                              │      │
│           ▼                                                               │      │
│  ┌─────────────────┐                                                      │      │
│  │   Coordinator   │──────────────────────────────┐                       │      │
│  │(tss/coordinator)│                              │                       │      │
│  └────────┬────────┘                              │                       │      │
│           │                                       │ BroadcastMessage()    │      │
│           │ PrepareKeygen()                       ▼                       │      │
│           │                              ┌─────────────────┐              │      │
│           │                              │    P2PHost      │              │      │
│           │                              │  (p2p/host.go)  │              │      │
│           │                              └────────┬────────┘              │      │
│           │                                       │                       │      │
│           │                                       │ Publish()             │      │
│           │                                       ▼                       │      │
│           │                              ┌─────────────────┐              │      │
│           │                              │    PubSub       │              │      │
│           │                              │ (p2p/pubsub.go) │              │      │
│           │                              └────────┬────────┘              │      │
│           │                                       │                       │      │
│           │                                       │  keygen_init 广播     │      │
│           │                                       │  到其他节点           │      │
│           │                                       ▼                       │      │
│           │                              ┌─────────────────┐              │      │
│           │                              │   Other Nodes   │              │      │
│           │                              │ Node-2, Node-3  │              │      │
│           │                              └────────┬────────┘              │      │
│           │                                       │                       │      │
│           │                                       │  keygen_ready 响应    │      │
│           │                              ◀────────┘                       │      │
│           │                                                               │      │
│           │ 所有节点就绪后                                                 │      │
│           │ 广播 keygen_start                                              │      │
│           │                                                               │      │
│           ▼                                                               │      │
│  ┌─────────────────┐                                                      │      │
│  │  KeygenSession  │◀─────────────────────────────────────────────────────┘      │
│  │(tss/keygen.go)  │  session.Start()                                           │
│  └────────┬────────┘                                                            │
│           │                                                                      │
│           │ run() - 主循环                                                       │
│           │                                                                      │
│           ├─────────────────────────────────────────────────┐                   │
│           │                                                  │                   │
│           ▼                                                  ▼                   │
│  ┌─────────────────┐                              ┌─────────────────┐           │
│  │   tss-lib       │                              │ MessageManager  │           │
│  │  LocalParty     │  outChan ─────────────────▶  │   发送TSS消息    │           │
│  │                 │  ◀───────────────── msgChan  │   接收TSS消息    │           │
│  │  - Round 1-3    │                              └─────────────────┘           │
│  │  - 生成分片     │                                                            │
│  └────────┬────────┘                                                            │
│           │ endChan (协议完成)                                                   │
│           ▼                                                                      │
│  ┌─────────────────┐                                                            │
│  │  handleSuccess  │                                                            │
│  └────────┬────────┘                                                            │
│           │                                                                      │
│           ├─────────────────────────────────────────────────┐                   │
│           │ SaveKeyShare()                                   │                   │
│           ▼                                                  ▼                   │
│  ┌─────────────────┐                              ┌─────────────────┐           │
│  │ KeyShareRepo    │                              │  WalletRepo     │           │
│  │ 保存加密的分片   │                              │  保存钱包信息    │           │
│  └────────┬────────┘                              └────────┬────────┘           │
│           │                                                 │                   │
│           └─────────────────────┬───────────────────────────┘                   │
│                                 ▼                                               │
│                        ┌─────────────────┐                                      │
│                        │    LevelDB      │                                      │
│                        └─────────────────┘                                      │
│                                                                                  │
│  返回给 Client:                                                                  │
│  {                                                                               │
│    "id": "wallet-uuid",                                                         │
│    "name": "MyWallet",                                                          │
│    "address": "0x...",                                                          │
│    "public_key": "0x...",                                                       │
│    "threshold": 2,                                                              │
│    "total_parts": 3                                                             │
│  }                                                                               │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 总结

### 关键设计决策

| 设计点 | 决策 | 原因 |
|--------|------|------|
| TSS 库 | BNB Chain tss-lib | 成熟的 **GG18** 实现，安全性经过验证 |
| MtA 实现 | Paillier 同态加密 | GG18 标准方案，安全性有数学证明 |
| P2P 框架 | libp2p | 去中心化、NAT穿透、多协议支持 |
| 消息广播 | GossipSub | 高效、可靠的消息传播 |
| 存储 | LevelDB | 轻量级、高性能 KV 存储 |
| 加密 | AES-256-GCM | 认证加密，保护密钥分片 |

### GG18 协议特点

- **论文**: *"Fast Multiparty Threshold ECDSA with Fast Trustless Setup"* (Gennaro & Goldfeder, 2018)
- **安全模型**: 诚实多数 (honest majority) 假设下的安全性
- **MtA 协议**: 基于 Paillier 同态加密
- **签名轮次**: 6 轮（比 GG20 多，但实现更简单）

### 安全保证

1. **密钥安全**: 完整私钥从未在任何地方出现
2. **门限安全**: 攻击者需要获取 t 个节点才能签名
3. **前向安全**: 通过定期 resharing，历史分片失效
4. **通信安全**: TLS/Noise 协议保护所有通信

### 性能指标

| 操作 | 预期时间 (3节点, 2阈值) |
|------|------------------------|
| 密钥生成 | 5-30 秒 |
| 签名 | 1-5 秒 |
| 密钥重分享 | 10-60 秒 |

---

*文档版本: 1.0*
*最后更新: 2024*
